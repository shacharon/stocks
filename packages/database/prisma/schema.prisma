// Prisma Schema for EOD Stock Analyzer
// Generator and datasource configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PORTFOLIO MANAGEMENT
// ============================================================================

model Portfolio {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  positions PortfolioPosition[]

  @@map("portfolios")
}

model PortfolioPosition {
  id          String   @id @default(uuid()) @db.Uuid
  portfolioId String   @map("portfolio_id") @db.Uuid
  symbol      String   @db.VarChar(50)
  market      Market
  buyPrice    Decimal  @map("buy_price") @db.Decimal(12, 4)
  quantity    Decimal? @db.Decimal(12, 4)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  portfolio     Portfolio           @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  stopRuleState StopRulesState?
  decisions     PortfolioDecision[]

  @@index([portfolioId])
  @@index([symbol, market])
  @@map("portfolio_positions")
}

// ============================================================================
// UNIVERSE MANAGEMENT
// ============================================================================

model SymbolUniverse {
  id          String   @id @default(uuid()) @db.Uuid
  symbol      String   @db.VarChar(50)
  market      Market
  isActive    Boolean  @default(true) @map("is_active")
  addedAt     DateTime @default(now()) @map("added_at") @db.Timestamptz(6)
  lastUpdated DateTime @updatedAt @map("last_updated") @db.Timestamptz(6)

  @@unique([symbol, market])
  @@index([isActive])
  @@map("symbol_universe")
}

model SymbolSectorMap {
  id          String   @id @default(uuid()) @db.Uuid
  symbol      String   @unique @db.VarChar(50)
  sector      String   @db.VarChar(100)
  industry    String?  @db.VarChar(100)
  lastUpdated DateTime @updatedAt @map("last_updated") @db.Timestamptz(6)

  @@index([sector])
  @@map("symbol_sector_map")
}

// ============================================================================
// PIPELINE TRACKING (Idempotency & Job Management)
// ============================================================================

model PipelineRun {
  id          String         @id @default(uuid()) @db.Uuid
  runDate     DateTime       @unique @map("run_date") @db.Date
  status      PipelineStatus @default(PENDING)
  startedAt   DateTime?      @map("started_at") @db.Timestamptz(6)
  completedAt DateTime?      @map("completed_at") @db.Timestamptz(6)
  errorMessage String?       @map("error_message") @db.Text
  metadata    Json?          @db.JsonB

  // Relations
  jobRuns JobRun[]

  @@index([runDate, status])
  @@map("pipeline_runs")
}

model JobRun {
  id             String      @id @default(uuid()) @db.Uuid
  pipelineRunId  String      @map("pipeline_run_id") @db.Uuid
  jobType        JobType     @map("job_type")
  status         JobStatus   @default(PENDING)
  startedAt      DateTime?   @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime?   @map("completed_at") @db.Timestamptz(6)
  errorMessage   String?     @map("error_message") @db.Text
  inputData      Json?       @map("input_data") @db.JsonB
  outputData     Json?       @map("output_data") @db.JsonB

  // Relations
  pipelineRun PipelineRun @relation(fields: [pipelineRunId], references: [id], onDelete: Cascade)

  @@unique([pipelineRunId, jobType])
  @@index([pipelineRunId])
  @@index([jobType, status])
  @@map("job_runs")
}

// ============================================================================
// MARKET DATA
// ============================================================================

model MarketDailyBar {
  id        String   @id @default(uuid()) @db.Uuid
  symbol    String   @db.VarChar(50)
  market    Market
  date      DateTime @db.Date
  open      Decimal  @db.Decimal(12, 4)
  high      Decimal  @db.Decimal(12, 4)
  low       Decimal  @db.Decimal(12, 4)
  close     Decimal  @db.Decimal(12, 4)
  volume    BigInt
  source    String   @db.VarChar(50)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)

  @@unique([symbol, market, date])
  @@index([symbol, market, date(sort: Desc)])
  @@index([date(sort: Desc)])
  @@map("market_daily_bars")
}

// ============================================================================
// ANALYSIS OUTPUTS (Portfolio-Neutral Features)
// ============================================================================

model DailySymbolFeatures {
  id              String   @id @default(uuid()) @db.Uuid
  symbol          String   @db.VarChar(50)
  market          Market
  date            DateTime @db.Date
  
  // Price data
  closePrice      Decimal  @map("close_price") @db.Decimal(12, 4)
  
  // Indicators
  sma20           Decimal? @map("sma_20") @db.Decimal(12, 4)
  sma50           Decimal? @map("sma_50") @db.Decimal(12, 4)
  rsi14           Decimal? @map("rsi_14") @db.Decimal(8, 4)
  atr14           Decimal? @map("atr_14") @db.Decimal(12, 4)
  volumeAvg20     BigInt?  @map("volume_avg_20")
  
  // Levels
  supportLevels   Json?    @map("support_levels") @db.JsonB
  resistanceLevels Json?   @map("resistance_levels") @db.JsonB
  
  // Regime
  trend           String?  @db.VarChar(20)
  volatilityState String?  @map("volatility_state") @db.VarChar(20)
  
  // Engine metadata
  engineVersion   String   @map("engine_version") @db.VarChar(20)
  confidence      Decimal? @db.Decimal(4, 3)
  reasons         Json?    @db.JsonB
  
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  portfolioDecisions PortfolioDecision[]

  @@unique([symbol, market, date])
  @@index([symbol, market, date(sort: Desc)])
  @@index([date(sort: Desc)])
  @@map("daily_symbol_features")
}

// ============================================================================
// PORTFOLIO-SPECIFIC DECISIONS (Buy-Price Aware Overlay)
// ============================================================================

model PortfolioDecision {
  id               String   @id @default(uuid()) @db.Uuid
  positionId       String   @map("position_id") @db.Uuid
  date             DateTime @db.Date
  
  // Context
  buyPrice         Decimal  @map("buy_price") @db.Decimal(12, 4)
  currentPrice     Decimal  @map("current_price") @db.Decimal(12, 4)
  
  // Stop-loss (NEVER DECREASES)
  suggestedStop    Decimal  @map("suggested_stop") @db.Decimal(12, 4)
  prevStop         Decimal? @map("prev_stop") @db.Decimal(12, 4)
  stopDistancePct  Decimal? @map("stop_distance_pct") @db.Decimal(6, 3)
  
  // Action
  action           Action
  actionConfidence Decimal? @map("action_confidence") @db.Decimal(4, 3)
  actionReasons    Json?    @map("action_reasons") @db.JsonB
  
  // Reference to universal features
  featureId        String?  @map("feature_id") @db.Uuid
  
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  position PortfolioPosition   @relation(fields: [positionId], references: [id], onDelete: Cascade)
  feature  DailySymbolFeatures? @relation(fields: [featureId], references: [id], onDelete: SetNull)

  @@unique([positionId, date])
  @@index([positionId, date(sort: Desc)])
  @@index([date(sort: Desc)])
  @@index([action])
  @@map("portfolio_daily_decisions")
}

model StopRulesState {
  id           String   @id @default(uuid()) @db.Uuid
  positionId   String   @unique @map("position_id") @db.Uuid
  currentStop  Decimal  @map("current_stop") @db.Decimal(12, 4)
  lastMovedAt  DateTime @map("last_moved_at") @db.Date
  history      Json?    @db.JsonB
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  position PortfolioPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@index([positionId])
  @@map("stop_rules_state")
}

// ============================================================================
// SECTOR ANALYSIS
// ============================================================================

model DailySectorList {
  id              String   @id @default(uuid()) @db.Uuid
  date            DateTime @db.Date
  sector          String   @db.VarChar(100)
  symbolList      Json     @map("symbol_list") @db.JsonB
  rankingCriteria Json?    @map("ranking_criteria") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([date, sector])
  @@index([date(sort: Desc)])
  @@index([sector])
  @@map("daily_sector_lists")
}

// ============================================================================
// DEEP DIVE & CHANGES
// ============================================================================

model DeepDiveReport {
  id         String   @id @default(uuid()) @db.Uuid
  symbol     String   @db.VarChar(50)
  market     Market
  date       DateTime @db.Date
  reportData Json     @map("report_data") @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([symbol, market, date])
  @@index([symbol, market, date(sort: Desc)])
  @@map("deep_dive_reports")
}

model DailyDelta {
  id               String   @id @default(uuid()) @db.Uuid
  symbol           String   @db.VarChar(50)
  market           Market
  date             DateTime @db.Date
  changeType       String   @map("change_type") @db.VarChar(50)
  oldValue         Json?    @map("old_value") @db.JsonB
  newValue         Json?    @map("new_value") @db.JsonB
  materialityScore Decimal? @map("materiality_score") @db.Decimal(4, 3)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([symbol, market, date, changeType])
  @@index([date(sort: Desc), materialityScore(sort: Desc)])
  @@index([symbol, market])
  @@map("daily_deltas")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Market {
  US
  TASE
}

enum Action {
  HOLD
  MOVE_STOP
  REDUCE
  EXIT
}

enum PipelineStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum JobType {
  MARKET_SYNC
  FEATURE_FACTORY
  SECTOR_SELECTOR
  CHANGE_DETECTOR
  DEEP_DIVE
}


